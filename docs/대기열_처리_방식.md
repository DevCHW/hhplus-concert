# 대기열 설계 및 구현 변경사항

## 초기 설계 (은행창구 방식, RDB 구현)

### 은행창구 방식이란?
은행창구 방식은 고객이 대기표를 받고 순서대로 창구에서 처리되는 방식을 의미합니다. 이는 선입선출(FIFO) 방식으로, 먼저 온 사용자가 먼저 처리됩니다.

시스템이 감당할 수 있는 트래픽 수(창구의 갯수)를 설정하여 엄격하게 트래픽을 관리할 수 있게 됩니다.

처리 방식:
- 변수 설정 : 현재 창구에서 업무를 보고 있는 사람 수: N, 대기표를 뽑고 기다리는 사람 수: M
- 창구에서 한 명이 빠져나가면(N-1), 우선 순위의 대기표를 가진 사람이 창구에 들어갑니다.(M+1, M+1)

예상보다 많은 트래픽이 몰려와도 과부하가 걸리지 않는다는 장점이 있지만, 처리가 되는 시간이 각각 달라 예상 대기시간을 알기 힘들다는 단점이 있습니다.   

### 구현
![ERD](./images/erd/ERD_v2.png)
1. 사용자는 대기열 토큰 생성 API를 통하여 `waiting_queue` 테이블에 상태를 `CREATED` 상태로 `INSERT`합니다.
2. 대기열 토큰 조회 API를 통해 발급받은 토큰의 상태를 Polling 방식으로 확인합니다.
3. 스케줄러가  `ACTIVE` 상태의 토큰이 최대 허용 수 미만인 경우 상태가 `CREATED`인 토큰 목록을 **생성된 순서대로** `ACTIVE` 상태로 변경합니다.  
4. 토큰의 상태가 `ACTIVE`인 경우 콘서트 예약 서비스를 이용할 수 있습니다.
5. 예약 및 결제가 완료되면, 발급받았던 토큰을 `waiting_queue` 테이블에서 `DELETE` 합니다.

## 변경 이후 설계 (놀이공원 방식, Redis 구현)

### 놀이공원 방식이란?
놀이공원 방식은 사용자가 먼저 대기열에 들어가고, 일정 수의 사용자(N명)가 한 번에 처리되는 방식입니다. 즉, 개별 창구에서 순서대로 처리되는 것이 아니라, 놀이기구가 일정 인원이 차야 출발하는 것과 유사한 방식입니다.

처리 방식:
- 변수 설정 : 놀이기구 탑승 인원 수: N, 놀이기구 1회 운행 시간: M
- 놀이기구 1회 운행이 끝날 때 마다(M) 대기열에서 놀이기구 탑승 인원 수(N) 만큼 입장시킵니다

은행 창구 방식과는 달리 일정 시간마다 자동으로 대기열에서 설정한 값 만큼 처리가 되기에 예상 대기 시간을 정확하게 알 수 있다는 장점이 있지만 적절한 변수 설정을 잘못할 경우 시스템 과부하가 걸릴 수 있습니다. 

### 구현
1. 사용자는 대기열 토큰 생성 API를 통하여 토큰(UUID)을 발급받고, Redis 대기열(SortedSet)에 토큰을 저장합니다.
2. 대기열 토큰 조회 API를 통해 발급받은 토큰의 상태를 Polling 방식으로 확인합니다.
3. 스케줄러가 일정 시간마다 대기열에서 **순서대로** 처리열(SortedSet)로 토큰을 옮깁니다.
4. 발급받은 토큰이 처리열에 존재할 경우 `ACTIVE` 상태로 판단하며, 콘서트 예약 서비스를 이용할 수 있게 됩니다.
5. 콘서트 예약 및 결제가 끝난 경우 발급받은 토큰을 제거합니다. 
