# 시나리오 별 동시성 제어 기법 적용 및 사용 이유

> 본 문서에서는 시나리오 별 발생할 수 있는 동시성 이슈와 이를 해결하기 위하여 적용한 동시성 제어 기법, 사용 이유에 대하여 정리합니다.

---

## 1. 동일한 유저의 잔고 충전 요청

### **동시성 요구사항**
- 동일한 유저에게 동시에 여러개의 충전 요청이 들어오면 1번만 성공해야 한다.

### **사용한 동시성 제어 기법**
- Lettuce 라이브러리를 이용한 Redis 분산락(SETNX) 적용
- Spin-Lock 방식에서 락을 획득하기 위한 대기시간을 0으로 설정하여 구현하였습니다.
- 위와 같이 대기시간을 0으로 설정하면 Spin-Lock으로 구현되어있는 로직에서 루프를 1번만 수행하기 때문에 락을 획득하지 못한 요청들은 모두 Exception이 발생하게 됩니다. 

### **해당 기법 사용 이유**
- 따닥 요청과 같은 동시에 동일한 정보로 들어온 요청에 대하여 한번만 성공되어야 하기에, 락을 획득하지 못한다면 Exception이 발생해야 합니다. 따라서 Pub-Sub 방식의 분산락을 제공해주는 Redisson 라이브러리를 굳이 사용할 필요가 없고, 성능적으로도 Lettuce 라이브러리를 이용하여 구현하는 것이 적합하다고 판단했습니다.   

---

## 2. 동일한 유저의 잔고 차감 요청

### **동시성 요구사항**
- 동일한 유저에게 동시에 여러개의 차감 요청이 들어오면 오차 없이 순차적으로 처리되어야 한다.

### **사용한 동시성 제어 기법**
- Redisson 라이브러리를 이용한 Pub-Sub 방식 Redis 분산락 적용
- Redisson 라이브러리의 tryLock()을 통하여 Pub-Sub 방식의 분산 락을 구현할 수 있었습니다.

#### **해당 기법 사용 이유**
- 동시에 들어온 요청이 순차적으로 처리가 되어야 하기에, Spin-Lock 방식으로 구현하는 것 보다 Pub-Sub 방식으로 구현하는 것이 레디스에 부하를 줄일 수 있어 적합하다고 판단하였습니다.

---

## 3. 동일한 좌석에 대한 예약 요청

### **동시성 요구사항**
- 동일한 좌석에 대해 동시에 여러번 예약 요청이 들어오더라도, 하나의 요청만 성공해야 한다.

### **사용한 동시성 제어 기법**
- Redisson 라이브러리를 이용한 Pub-Sub 방식 Redis 분산락 적용 + 데이터베이스 유니크 제약조건
- 좌석에 대한 예약은 다수의 서버와 사용자 요청이 분산 환경에서 동시다발적으로 들어올 가능성이 크므로, 분산 락을 활용하여 중복 처리를 방지합니다. 그 중에서도 레디스의 부하를 줄일 수 있는 Pub-Sub 방식의 분산 락이 적합하다고 판단하였습니다.

### **해당 기법 사용 이유**
- 예약 특성 상 순간적으로 밀려오는 트래픽이 많을 것으로 생각되기에 최대한 부하를 분산시킬 수 있는 분산락 방식의 구현이 적합하다고 판단됩니다.
- 분산락 중에서도 레디스의 부하를 줄일 수 있는 Pub-Sub 방식이 적합하다고 판단하였습니다.
- 레디스의 장애 상황을 고려하여, 데이터베이스의 예약 테이블에 좌석 ID를 유니크로 설정하여 하나의 좌석ID에 대하여 하나의 예약만 생성될 수 있도록 보장해주었습니다.

---

## 4. 동일한 예약에 대한 결제 요청

### **동시성 요구사항**
- 동일한 예약에 대해 동시에 여러번 결제 요청이 들어오더라도, 하나의 요청만 성공해야 한다.

### **사용한 동시성 제어 기법**
- Redisson 라이브러리를 이용한 Pub-Sub 방식 Redis 분산락 적용

### **해당 기법 사용 이유**
- 하나의 예약에 대하여 동시에 결제 요청이 여러번 들어올 확률은 낮습니다. 해당 부분은 오히려 데이터베이스의 Optimistic Lock을 적용하는 것이 성능적으로 이득이 있을 것이라 판단되지만 학습 목적으로 분산 락을 적용시켜두었습니다.

---

## 결론
데이터베이스 락과 비교하여 구현의 난이도는 분산 락이 더 높고 고려해야 할 사항이 많으나, 데이터베이스의 부하를 줄일 수 있다는 점, 데이터베이스의 스케일아웃에도 대응을 할 수 있다는 점에서 대규모 시스템에서는 분산 락을 활용하여 동시성을 처리하는 것이 적합할 것으로 보입니다.  
또한 레디스의 장애까지 고려한다면 서킷브레이커를 통하여 락을 이중으로 수행할 수 있도록 하는 적절한 조치가 필요합니다. 그러나 이는 확률이 매우 낮고 대부분의 상황에서는 오버헤드일 가능성이 높기 때문에, 장애 발생 시 서비스나 비즈니스에 미치는 영향도에 따라서 선택해야할 사항이라고 생각됩니다.
현재 구현은 단일 노드로 구성된 레디스를 가정하여 구현하였으나, 이후 여러 클러스터로 구성된 레디스 사용 시 RedLock 알고리즘 사용 설정 또는 네트워크 토폴로지 설정과 같은 추가적인 설정을 하여 사용해야 합니다.


